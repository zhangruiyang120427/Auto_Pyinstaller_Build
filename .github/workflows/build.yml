# å·¥ä½œæµåç§°ï¼šPythonä¸€é”®æ‰“åŒ… | è‡ªå®šä¹‰å‚æ•° | æŒ‡å®šç›®å½•å­˜æ”¾ | è‡ªåŠ¨æ¸…ç†æ–‡ä»¶
name: Pythonæ‰“åŒ…-å¯è§†åŒ–é…ç½®-è‡ªåŠ¨æ¸…ç†-æŒ‡å®šç›®å½•å­˜æ”¾

# Run workflowæŒ‰é’®ä¸‹çš„å¯è§†åŒ–è‡ªå®šä¹‰å‚æ•°ï¼ˆå…¨éƒ¨ä¿ç•™ï¼š-w/-c/-F/-n/ç‰ˆæœ¬/ä¾èµ–ï¼‰
on:
  workflow_dispatch:
    inputs:
      console_mode:
        description: 'ç¨‹åºè¿è¡Œæ—¶æ˜¯å¦æ˜¾ç¤ºé»‘è‰²æ§åˆ¶å°çª—å£'
        required: true
        default: 'æ— æ§åˆ¶å°çª—å£(-w) æ¨èGUIç¨‹åº'
        type: choice
        options:
          - æ— æ§åˆ¶å°çª—å£(-w) æ¨èGUIç¨‹åº
          - æ˜¾ç¤ºæ§åˆ¶å°çª—å£(-c) æ¨èå¸¦printçš„ç¨‹åº
      build_mode:
        description: 'æ‰“åŒ…æ–‡ä»¶æ ¼å¼'
        required: true
        default: 'å•ä¸ªç‹¬ç«‹exe(-F) æ¨è'
        type: choice
        options:
          - å•ä¸ªç‹¬ç«‹exe(-F) æ¨è
          - æ–‡ä»¶å¤¹å½¢å¼(æ— -F) é€‚åˆå¤§é¡¹ç›®
      exe_name:
        description: 'è‡ªå®šä¹‰æ‰“åŒ…åçš„EXEæ–‡ä»¶å (ä¸ç”¨å†™.exeåç¼€ï¼Œç•™ç©ºé»˜è®¤ï¼šmain)'
        required: false
        default: ''
      python_ver:
        description: 'é€‰æ‹©æ‰“åŒ…ç”¨çš„Pythonç‰ˆæœ¬ã€å¿…é¡»å’Œä½ æœ¬åœ°ä¸€è‡´ï¼ã€‘'
        required: true
        default: '3.10'
        type: choice
        options:
          - 3.8
          - 3.9
          - 3.10
          - 3.11
      py_deps:
        description: 'é¡¹ç›®ä¾èµ–åŒ…(çº¯Pythonæ— ä¾èµ–åˆ™ç•™ç©ºï¼Œå¤šä¸ªä¾èµ–ç”¨ç©ºæ ¼åˆ†éš”)'
        required: false
        default: ''

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: æ‹‰å–ä»“åº“æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…å«filesæ–‡ä»¶å¤¹å†…çš„pyæºç ï¼‰
        uses: actions/checkout@v4

      - name: ğŸ”´ã€æ‰“åŒ…å‰ç½®ã€‘è‡ªåŠ¨æ¸…ç† buildæ–‡ä»¶å¤¹å†… æ‰€æœ‰æ—§çš„exeæ–‡ä»¶ï¼ˆåªåˆ exeï¼Œä¸åˆ æ–‡ä»¶å¤¹/å…¶ä»–æ–‡ä»¶ï¼‰
        run: |
          # åˆ›å»ºbuildæ–‡ä»¶å¤¹ï¼ˆå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºï¼Œé¿å…æŠ¥é”™ï¼Œä¸ä¼šå½¢æˆå¹½çµæ–‡ä»¶å¤¹ï¼‰
          if (-not (Test-Path -Path "build")) { New-Item -ItemType Directory -Path "build" | Out-Null }
          # ä»…åˆ é™¤buildç›®å½•ä¸‹çš„ *.exe æ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶/å­æ–‡ä»¶å¤¹å…¨éƒ¨ä¿ç•™
          Get-ChildItem -Path "build" -Filter "*.exe" -File | Remove-Item -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… å·²æ¸…ç†buildæ–‡ä»¶å¤¹å†…æ‰€æœ‰æ—§exeæ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹ä¿ç•™"

      - name: é…ç½®é€‰æ‹©çš„Pythonç‰ˆæœ¬
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_ver }}

      - name: å®‰è£…æ‰“åŒ…å·¥å…·PyInstallerå’Œé¡¹ç›®ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller ${{ github.event.inputs.py_deps }}

      - name: æ ¸å¿ƒæ‰“åŒ… - è¯»å–å¯è§†åŒ–å‚æ•°è‡ªåŠ¨æ‹¼æ¥å‘½ä»¤ + æŒ‡å®šæ‰“åŒ…æºæ–‡ä»¶ä¸ºfilesç›®å½•ä¸‹çš„main.py
        run: |
          # åˆå§‹åŒ–æ‰“åŒ…å‘½ä»¤ï¼ŒæŒ‡å®šæºç è·¯å¾„ä¸º files/main.py æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼
          $cmd = "pyinstaller files/main.py"
          
          # æ ¹æ®é€‰æ‹©çš„å‚æ•°æ‹¼æ¥ -F / -w/-c / -n
          if ("${{ github.event.inputs.build_mode }}" -eq "å•ä¸ªç‹¬ç«‹exe(-F) æ¨è") { $cmd += " -F" }
          if ("${{ github.event.inputs.console_mode }}" -eq "æ— æ§åˆ¶å°çª—å£(-w) æ¨èGUIç¨‹åº") { $cmd += " -w" } else { $cmd += " -c" }
          if ("${{ github.event.inputs.exe_name }}" -ne "") { $cmd += " -n ${{ github.event.inputs.exe_name }}" }
          
          # æ‰§è¡Œæ‰“åŒ…å‘½ä»¤
          Write-Host "âœ… æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼š" $cmd
          Invoke-Expression $cmd

      - name: ğŸ”´ã€äº§ç‰©è¿ç§»ã€‘å°†æ‰“åŒ…å¥½çš„exeæ–‡ä»¶ ä»é»˜è®¤distç›®å½• ç§»åŠ¨åˆ° è‡ªå®šä¹‰buildæ–‡ä»¶å¤¹
        run: |
          # å®šä¹‰exeæ–‡ä»¶åï¼ˆå…¼å®¹è‡ªå®šä¹‰åç§°å’Œé»˜è®¤åç§°ï¼‰
          $exeName = "${{ github.event.inputs.exe_name }}"
          if ($exeName -eq "") { $exeName = "main" }
          # ç§»åŠ¨distç›®å½•ä¸‹çš„exeåˆ°buildç›®å½•ï¼Œè¦†ç›–åŒåæ—§æ–‡ä»¶ï¼ˆä¿è¯æ˜¯æœ€æ–°äº§ç‰©ï¼‰
          Move-Item -Path "dist/$exeName.exe" -Destination "build/" -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… å·²å°†æœ€æ–°exeæ–‡ä»¶è¿ç§»è‡³ build æ–‡ä»¶å¤¹"

      - name: ğŸ”´ã€æ‰“åŒ…æ”¶å°¾ã€‘è‡ªåŠ¨åˆ é™¤ filesæ–‡ä»¶å¤¹å†… æ‰€æœ‰.pyæºç æ–‡ä»¶ï¼ˆåªåˆ pyï¼Œä¸åˆ æ–‡ä»¶å¤¹/å…¶ä»–æ–‡ä»¶ï¼Œæœç»å¹½çµæ–‡ä»¶å¤¹ï¼‰
        run: |
          # ä»…åˆ é™¤filesç›®å½•ä¸‹çš„ *.py æ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶/å­æ–‡ä»¶å¤¹å…¨éƒ¨ä¿ç•™
          Get-ChildItem -Path "files" -Filter "*.py" -File | Remove-Item -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… å·²æ¸…ç†filesæ–‡ä»¶å¤¹å†…æ‰€æœ‰pyæºç æ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹ä¿ç•™"

      - name: ä¸Šä¼ æœ€ç»ˆæ‰“åŒ…äº§ç‰©ï¼ˆbuildæ–‡ä»¶å¤¹å†…çš„exeï¼Œä¾›ä¸‹è½½ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: Windowsæœ€ç»ˆæ‰“åŒ…äº§ç‰©_${{ github.event.inputs.exe_name || 'main' }}
          path: build/*.exe
